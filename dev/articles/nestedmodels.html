<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="An introduction to the nestedmodels package">
<title>Getting started with nestedmodels • nestedmodels</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting started with nestedmodels">
<meta property="og:description" content="An introduction to the nestedmodels package">
<meta property="og:image" content="https://ashbythorpe.github.io/nestedmodels/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">nestedmodels</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.1.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/nestedmodels.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/nestedmodels-limitations.html">Nestedmodels Limitations</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ashbythorpe/nestedmodels/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Getting started with nestedmodels</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ashbythorpe/nestedmodels/blob/HEAD/vignettes/nestedmodels.Rmd" class="external-link"><code>vignettes/nestedmodels.Rmd</code></a></small>
      <div class="d-none name"><code>nestedmodels.Rmd</code></div>
    </div>

    
    
<p>This vignette provides an introduction to the nestedmodels package
and the most basic use case. For this and all other vignettes, it is
assumed that you have a familiarity with the ‘<a href="https://www.tidymodels.org/" class="external-link">tidymodels</a>’ framework (e.g. by
reading <a href="https://www.tmwr.org/" class="external-link">Tidy Modelling with R</a>). This
vignette does not aim to teach good statistical practices, and instead
demonstrates how to use the package as simply as possible.</p>
<div class="section level2">
<h2 id="what-is-nestedmodels">What is nestedmodels?<a class="anchor" aria-label="anchor" href="#what-is-nestedmodels"></a>
</h2>
<p>nestedmodels is an extension to the ‘<a href="https://www.tidymodels.org/" class="external-link">tidymodels</a>’ framework. It allows
models and workflows to be used on <a href="https://tidyr.tidyverse.org/articles/nest.html" class="external-link">nested data</a>.
It provides an alternative to <a href="https://business-science.github.io/modeltime/articles/nested-forecasting.html" class="external-link">modeltime’s
approach to nested modelling</a> or the ‘<a href="https://multilevelmod.tidymodels.org/" class="external-link">multilevelmod</a>’ package,
allowing any model or workflow to be used on nested data very
easily.</p>
</div>
<div class="section level2">
<h2 id="why-do-i-need-nestedmodels">Why do I need nestedmodels?<a class="anchor" aria-label="anchor" href="#why-do-i-need-nestedmodels"></a>
</h2>
<p>The best example where you may need to use the nestedmodels package
is when working with panel data. When you have a set of time series,
each describing a different object (the historic prices for a set of
stocks, for example), you may want to model each time series separately,
especially considering the fact that many time series modelling tools do
not work well with non-date predictors (and furthermore, many models do
not accept non-numeric predictors, although there are often better ways
to deal with this problem; see <code><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">recipes::step_dummy()</a></code>). In
this scenario, nested modelling is often the best solution.</p>
</div>
<div class="section level2">
<h2 id="how-does-nestedmodels-work">How does nestedmodels work?<a class="anchor" aria-label="anchor" href="#how-does-nestedmodels-work"></a>
</h2>
<p>The implementation of nestedmodels is very simple. Fitting a nested
model fits the model to each nested value (for time series about a set
of stocks, a model would be fitted to each stock). The correct model
will then be selected and used when making predictions.</p>
</div>
<div class="section level2">
<h2 id="a-quick-example">A quick example<a class="anchor" aria-label="anchor" href="#a-quick-example"></a>
</h2>
<p>In this vignette, we’re going to explore the most basic example of a
nested model. You’re going to need the following packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ashbythorpe/nestedmodels" class="external-link">nestedmodels</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/parsnip" class="external-link">parsnip</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/recipes" class="external-link">recipes</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/workflows" class="external-link">workflows</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rsample.tidymodels.org" class="external-link">rsample</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glmnet.stanford.edu" class="external-link">glmnet</a></span><span class="op">)</span></span></code></pre></div>
<p>We’re going to use the example data included in the nestedmodels
package. The data is very simple, and only serves as an example of data
that can be nested, rather than representing anything concrete.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"example_nested_data"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">example_nested_data</span></span>
<span><span class="va">data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,000 × 7</span></span></span>
<span><span class="co">#&gt;       id   id2     x     y     z     a     b</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1     1    49  48.5  29.1  44.7 50.0 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1     1    50  64.2  29.7  40.2 64.9 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1     1    51 -<span style="color: #BB0000;">19.4</span>  26.6  43.2 38.0 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1     1    52  41.0  28.8  66.4 61.7 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1     1    53 -<span style="color: #BB0000;">94.2</span>  23.9  18.2 -<span style="color: #BB0000;">1.66</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1     1    54  72.6  30.0  83.8 38.8 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1     1    55 -<span style="color: #BB0000;">91.5</span>  24.0  91.7 40.7 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1     1    56 -<span style="color: #BB0000;">50.5</span>  25.5  79.8 55.4 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1     1    57  90.3  30.6  50.3 33.8 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     1     1    58  32.4  28.6  25.4 20.5 </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 990 more rows</span></span></span></code></pre></div>
<p>The data can be nested in the following way:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nested_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span><span class="va">data</span>, data <span class="op">=</span> <span class="op">-</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="va">nested_data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 20 × 2</span></span></span>
<span><span class="co">#&gt;       id data             </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>    11 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span>    12 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span>    13 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span>    14 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span>    15 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span>    16 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span>    17 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span>    18 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">19</span>    19 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">20</span>    20 <span style="color: #949494;">&lt;tibble [50 × 6]&gt;</span></span></span></code></pre></div>
<p>Lets split this data up into a training and testing set using the
<code><a href="../reference/nested_resamples.html">nested_resamples()</a></code> function. This ensures that the training
and testing set all contain data with every ‘id’ value.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">split</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nested_resamples.html">nested_resamples</a></span><span class="op">(</span><span class="va">nested_data</span>, <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">initial_split</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data_tr</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">training</a></span><span class="op">(</span><span class="va">split</span><span class="op">)</span></span>
<span><span class="va">data_tst</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">testing</a></span><span class="op">(</span><span class="va">split</span><span class="op">)</span></span></code></pre></div>
<p>Now let’s define our model:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"glmnet"</span><span class="op">)</span></span></code></pre></div>
<p>Since we’re fitting this model to nested data, we need some way to
make the model ‘nested’. This is very simple with the
<code><a href="../reference/nested.html">nested()</a></code> function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nested_model</span> <span class="op">&lt;-</span> <span class="va">model</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/nested.html">nested</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">nested_model</span></span>
<span><span class="co">#&gt; Nested Model Specification</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Inner model:</span></span>
<span><span class="co">#&gt; Linear Regression Model Specification (regression)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Main Arguments:</span></span>
<span><span class="co">#&gt;   penalty = 0.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: glmnet</span></span></code></pre></div>
<p>We can then fit this model in the usual way. Note that the data must
be nested, and formula cannot include the id column.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nested_tr</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span><span class="va">data_tr</span>, data <span class="op">=</span> <span class="op">-</span><span class="va">id</span><span class="op">)</span></span>
<span><span class="va">model_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">nested_model</span>, <span class="va">z</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span> <span class="op">+</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span>, <span class="va">nested_tr</span><span class="op">)</span></span>
<span><span class="va">model_fit</span></span>
<span><span class="co">#&gt; Nested model fit, with 20 inner models</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 20 × 2</span></span></span>
<span><span class="co">#&gt;       id .model_fit</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>    11 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span>    12 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span>    13 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span>    14 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span>    15 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span>    16 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span>    17 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span>    18 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">19</span>    19 <span style="color: #949494;">&lt;fit[+]&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">20</span>    20 <span style="color: #949494;">&lt;fit[+]&gt;</span></span></span></code></pre></div>
<p>Predicting can also be done in the usual way (the data to predict on
can be both nested and non-nested). Since this is just a demonstration,
we use the same data that the model was fitted on.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model_fit</span>, <span class="va">data_tst</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 260 × 1</span></span></span>
<span><span class="co">#&gt;    .pred</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  33.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  35.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  37.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  39.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  29.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  29.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  32.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  37.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  32.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  41.7</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 250 more rows</span></span></span></code></pre></div>
<p>This method is fine, but having to nest the data ourselves is a pain.
We can solve this by using a workflow.</p>
<p>We first define the recipe, and we define a step which is used to
nest the data. This time, the formula can include the ‘id’ column, since
the recipe needs to act on it.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recipe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">data_tr</span>, <span class="va">z</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span> <span class="op">+</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">+</span> <span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/step_nest.html">step_nest</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span></code></pre></div>
<p>This is a little easier than nesting the data manually. Note that the
recipe does not actually nest the data, but instead removes the
specified columns and adds a new column, ‘.nest_id’, which specifies
which nest each row belongs to.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recipe</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/prep.html" class="external-link">prep</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/bake.html" class="external-link">bake</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 740 × 6</span></span></span>
<span><span class="co">#&gt;        x      y     a      b      z .nest_id</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>    65  94.6  54.8  74.7   22.9   Nest 1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    71   2.70 65.2  25.9   36.1   Nest 1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    84 -<span style="color: #BB0000;">26.1</span>  83.0  71.5   52.6   Nest 1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>    57  90.3  50.3  33.8   30.6   Nest 1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    62 109.    5.23 19.8   23.4   Nest 1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>    86 104.   63.8  -<span style="color: #BB0000;">0.387</span> 57.4   Nest 1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    90 -<span style="color: #BB0000;">29.9</span>  84.2  65.3    0.767 Nest 1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    50  64.2  40.2  64.9   29.7   Nest 1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    76 -<span style="color: #BB0000;">37.7</span>  60.8  72.2   52.2   Nest 1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    94  89.9  26.5  54.7    5.14  Nest 1  </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 730 more rows</span></span></span></code></pre></div>
<p>Now we create the workflow, combining the recipe and the model.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://workflows.tidymodels.org/reference/workflow.html" class="external-link">workflow</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_model.html" class="external-link">add_model</a></span><span class="op">(</span><span class="va">nested_model</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://workflows.tidymodels.org/reference/add_recipe.html" class="external-link">add_recipe</a></span><span class="op">(</span><span class="va">recipe</span><span class="op">)</span></span></code></pre></div>
<p>A workflow can be fitted in the same way as a model, but note that
since we used <code><a href="../reference/step_nest.html">step_nest()</a></code> the data does not have to be
nested.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wf_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html" class="external-link">fit</a></span><span class="op">(</span><span class="va">wf</span>, <span class="va">data_tr</span><span class="op">)</span></span></code></pre></div>
<p>This fit object can then be used to make predictions.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">wf_fit</span>, <span class="va">data_tst</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 260 × 1</span></span></span>
<span><span class="co">#&gt;    .pred</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  33.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>  35.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>  37.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>  39.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>  29.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>  29.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>  32.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>  37.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>  32.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>  41.7</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 250 more rows</span></span></span></code></pre></div>
<p>Other common parsnip functions can also be used on fitted nested
models:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment</a></span><span class="op">(</span><span class="va">wf_fit</span>, <span class="va">data_tst</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 260 × 8</span></span></span>
<span><span class="co">#&gt;       id   id2     x      y     z     a      b .pred</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1     1    51 -<span style="color: #BB0000;">19.4</span>   26.6 43.2  38.0    33.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     1     1    53 -<span style="color: #BB0000;">94.2</span>   23.9 18.2  -<span style="color: #BB0000;">1.66</span>   35.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     1     1    54  72.6   30.0 83.8  38.8    37.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     1     1    58  32.4   28.6 25.4  20.5    39.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     1     1    59 -<span style="color: #BB0000;">13.1</span>   26.9 66.7  54.5    29.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     1     1    61 -<span style="color: #BB0000;">79.5</span>   24.5 98.1  18.4    29.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     1     1    66  46.0   21.2 30.4  60.6    32.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     1     1    70  -<span style="color: #BB0000;">8.65</span>  35.7  3.10 12.6    37.3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     1     2    74  75.8   38.8 98.7  57.2    32.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     1     2    75  62.5   55.8 82.9   0.128  41.7</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 250 more rows</span></span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">wf_fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 100 × 4</span></span></span>
<span><span class="co">#&gt;    .nest_id term         estimate penalty</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Nest 1   (Intercept)   47.7        0.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Nest 1   x             -<span style="color: #BB0000;">0.107</span>      0.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Nest 1   y              0.069<span style="text-decoration: underline;">7</span>     0.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Nest 1   a             -<span style="color: #BB0000;">0.028</span><span style="color: #BB0000; text-decoration: underline;">1</span>     0.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Nest 1   b             -<span style="color: #BB0000;">0.173</span>      0.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Nest 2   (Intercept) -<span style="color: #BB0000;">109.</span>         0.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Nest 2   x              0.840      0.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Nest 2   y             -<span style="color: #BB0000;">0.037</span><span style="color: #BB0000; text-decoration: underline;">5</span>     0.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Nest 2   a             -<span style="color: #BB0000;">0.051</span><span style="color: #BB0000; text-decoration: underline;">5</span>     0.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Nest 2   b              0.052<span style="text-decoration: underline;">8</span>     0.1</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 90 more rows</span></span></span></code></pre></div>
<p>This is all you really need to know to use the nestedmodels package.
These models and workflows can be compared, fitted and tuned in much the
same way as normal models and workflows - you can even combine them with
normal models using the workflowsets and stacks packages.</p>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In this short vignette, a simple example of a nested model and
workflow were created and used on dummy data, to demonstrate how
nestedmodels is used.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Ashby Thorpe.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
